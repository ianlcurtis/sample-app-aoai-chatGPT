{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "searchServiceName": { "type": "string" },
    "location": { "type": "string", "defaultValue": "[resourceGroup().location]" },
    "sku": { "type": "string", "defaultValue": "standard" },
    "searchApiKey": { "type": "securestring" },
    "storageConnectionString": { "type": "securestring" },
    "blobContainerName": { "type": "string" }
  },
  "resources": [
    {
      "type": "Microsoft.Search/searchServices",
      "apiVersion": "2020-08-01",
      "name": "[parameters('searchServiceName')]",
      "location": "[parameters('location')]",
      "sku": { "name": "[parameters('sku')]" },
      "properties": {
        "replicaCount": 1,
        "partitionCount": 1,
        "hostingMode": "default"
      }
    },
    {
      "type": "Microsoft.Resources/deploymentScripts",
      "apiVersion": "2020-10-01",
      "name": "CreateSearchResources",
      "location": "[parameters('location')]",
      "kind": "AzurePowerShell",
      "dependsOn": [
        "[resourceId('Microsoft.Search/searchServices', parameters('searchServiceName'))]"
      ],
      "properties": {
        "azPowerShellVersion": "10.4",
        "timeout": "PT10M",
        "forceUpdateTag": "[newGuid()]",
        "cleanupPreference": "OnSuccess",
        "arguments": "",
        "scriptContent": "[concat(
          \"$searchName = '\", parameters('searchServiceName'), \"'\\n\",
          \"$apiKey = '\", parameters('searchApiKey'), \"'\\n\",
          \"$storageConnectionString = '\", parameters('storageConnectionString'), \"'\\n\",
          \"$containerName = '\", parameters('blobContainerName'), \"'\\n\",
          \"$url = \\\"https://$searchName.search.windows.net\\\"\\n\\n\",
          \"$headers = @{\\\"Content-Type\\\" = \\\"application/json\\\"; \\\"api-key\\\" = $apiKey }\\n\\n\",
          \"# Data Source\\n\",
          \"$dataSource = @{\\n\",
          \"  name = 'blob-ds'\\n\",
          \"  description = 'Blob Data Source'\\n\",
          \"  type = 'azureblob'\\n\",
          \"  credentials = @{ connectionString = $storageConnectionString }\\n\",
          \"  container = @{ name = $containerName }\\n\",
          \"} | ConvertTo-Json -Depth 10\\n\",
          \"Invoke-RestMethod -Uri \\\"$url/datasources?api-version=2020-06-30\\\" -Method Put -Headers $headers -Body $dataSource\\n\\n\",
          \"# Index\\n\",
          \"$index = @{\\n\",
          \"  name = 'my-index'\\n\",
          \"  fields = @(\\n\",
          \"    @{ name='id'; type='Edm.String'; key=\$true },\\n\",
          \"    @{ name='content'; type='Edm.String' },\\n\",
          \"    @{ name='metadata_storage_name'; type='Edm.String' },\\n\",
          \"    @{ name='metadata_storage_path'; type='Edm.String' },\\n\",
          \"    @{ name='metadata_storage_last_modified'; type='Edm.DateTimeOffset' }\\n\",
          \"  )\\n\",
          \"} | ConvertTo-Json -Depth 10\\n\",
          \"Invoke-RestMethod -Uri \\\"$url/indexes/my-index?api-version=2020-06-30\\\" -Method Put -Headers $headers -Body $index\\n\\n\",
          \"# Indexer\\n\",
          \"$indexer = @{\\n\",
          \"  name = 'my-indexer'\\n\",
          \"  dataSourceName = 'blob-ds'\\n\",
          \"  targetIndexName = 'my-index'\\n\",
          \"  schedule = @{ interval = 'PT1H' }\\n\",
          \"  fieldMappings = @(\\n\",
          \"    @{ sourceFieldName = 'metadata_storage_path'; targetFieldName = 'id' },\\n\",
          \"    @{ sourceFieldName = 'content'; targetFieldName = 'content' }\\n\",
          \"  )\\n\",
          \"} | ConvertTo-Json -Depth 10\\n\",
          \"Invoke-RestMethod -Uri \\\"$url/indexers/my-indexer?api-version=2020-06-30\\\" -Method Put -Headers $headers -Body $indexer\\n\"
        )]"
      }
    }
  ]
}
